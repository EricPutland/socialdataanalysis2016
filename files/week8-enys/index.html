<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8">
<title>Week 8</title>
<script type="text/javascript" src="d3.v3.min.js"></script>
<style>
#tooltip {
    position: absolute;
    width: 200px;
    height: auto;
    padding: 10px;
    background-color: white;
    -webkit-border-radius: 10px;
    -moz-border-radius: 10px;
    border-radius: 10px;
    -webkit-box-shadow: 4px 4px 10px rgba(0, 0, 0, 0.4);
    -mox-box-shadow: 4px 4px 4px 10px rgba(0, 0, 0, 0.4);
    box-shadow: 4px 4px 10px rbga(0, 0, 0, 0.4);
    pointer-events: none;
}
#tooltip.hidden {
    opacity: 0;
}
#tooltip p {
    margin: 0;
    font-family: sans-serif;
    font-size: 16px;
    line-height: 20px;
}
</style>
</head>
<body>

<div id="tooltip" class="hidden">
    <p><strong><span id="district"></span></strong></p>
    <p><span id="cases"></span></p>
</div>

<script type="text/javascript">
var w = 800;
var h = 500;
var svg = d3.select("body")
    .append("svg")
    .attr("width", w)
    .attr("height", h);
var districts = [];
var projection = d3.geo.mercator()
                    .scale(1)
                    .translate([0, 0])
                    .precision(0);
var DAYS = {
    "Monday": 0,
    "Tuesday": 1,
    "Wednesday": 2,
    "Thursday": 3,
    "Friday": 4,
    "Saturday": 5,
    "Sunday": 6,
}
var DAYNAMES = ["Monday", "Tuesday", "Wednesday", "Thursday", "Friday", "Saturday", "Sunday"];

function makeMap(json) {
    // path
    var path = d3.geo.path().projection(projection);   

    // bounds
    var bounds = path.bounds(json);
  
    // scale functions
    var xScale = w / Math.abs(bounds[1][0] - bounds[0][0]);
    var yScale = h / Math.abs(bounds[1][1] - bounds[0][1]);
    var scale = xScale < yScale ? xScale : yScale;
    var t = [(w - scale * (bounds[1][0] + bounds[0][0])) / 2,
             (h - scale * (bounds[1][1] + bounds[0][1])) / 2];
    projection.scale(scale).translate(t);

    // make svg
    svg.selectAll("path")
        .data(json.features).enter()
        .append("path")
        .attr("d", path)
        .attr('data-id', function(d) { return d.id; })
        .attr('data-name', function(d) { return d.properties.name; })
        .style("fill", "#3399ff")
        .style("stroke", "#ffffff");
}

function getStat(data) {
    var dMap = {};
    data.forEach(function(d) {
        if(d.Category == "PROSTITUTION") {
            if(!dMap[d.PdDistrict])
                dMap[d.PdDistrict] = {
                    n: 0,
                    x: 0,
                    y: 0,
                    days: [0, 0, 0, 0, 0, 0, 0]
                };
            dMap[d.PdDistrict].n++;
            dMap[d.PdDistrict].x += +d.X;
            dMap[d.PdDistrict].y += +d.Y;
            dMap[d.PdDistrict].days[DAYS[d.DayOfWeek]]++;
        }
    });
    for(var d in dMap) {
        dMap[d].x /= dMap[d].n;
        dMap[d].y /= dMap[d].n;
    }

    // make list data
    districts = [];
    for(var d in dMap) {
        districts.push({
            name: d,
            n: dMap[d].n,
            x: dMap[d].x,
            y: dMap[d].y,
            days: dMap[d].days
        });
    }
    plotStat();
}

function plotStat() {
    r = d3.scale.linear()
        .domain([0, d3.max(districts, function(d) { return d.n; })])
        .range([15, 30]);
    var innerRadius = 0;
    var color = d3.scale.category10();
    districts.forEach(function(d) {
        console.log(d);
        var p = projection([d.x, d.y]);
        var arc = d3.svg.arc()
                .innerRadius(innerRadius)
                .outerRadius(r(d.n));
        var pie = d3.layout.pie();
        var arcs = svg.selectAll("." + d.name)
                    .data(pie(d.days)).enter()
                    .append("g")
                    .attr("class", "arc")
                    .attr("transform", "translate(" + (p[0]) + "," + (p[1]) + ")")
                    // show tooltip
                    .on("mouseover", function (dd, i) {
                        d3.select("#tooltip")
                            .style("left", d3.event.pageX + "px")
                            .style("top", d3.event.pageY + "px")
                            .style("opacity", 1);
                        d3.select("#tooltip").select("#district").text(d.name + " (" + DAYNAMES[i] + ")");
                        d3.select("#tooltip").select("#cases").text("cases: " + dd.value);
                    })
                    // hide tooltip
                    .on("mouseout", function () {
                        d3.select("#tooltip")
                            .style("opacity", 0);
                    });
        arcs.append("path")
            .attr("fill", function(dd, i) { return color(i); })
            .attr("d", arc);
    });

    /*svg.selectAll("circle")
           .data(districts).enter()
           .append("circle")
           .attr("cx", function(d) { return projection([d.x, d.y])[0]; })
           .attr("cy", function(d) { return projection([d.x, d.y])[1]; })
           .attr("r", 10)
           .style("fill", "white");*/
}

d3.json("sfpddistricts.geojson", function(json) {
    makeMap(json);

    d3.csv("pros-data.csv", function(data) {
        getStat(data);
    });
});
</script>
</body>
</html>